USE GrainStorageDB;CREATE OR ALTER TRIGGER TRG_MOVEMENT_UpdateSiloOccupancy --Movement a kayýt gelirse, silinirse, güncellenirse ilgiliON MOVEMENT                                              --siloda silo_total_occupancy artýp azalýyorAFTER INSERT, UPDATE, DELETEAS                                                    BEGIN                                                    --to_compartment_id giriþ    SET NOCOUNT ON;                                      --from_compartment_id çýkýþ    ;WITH delta AS (        --yeni eklenen        SELECT            sc.silo_id,            SUM(                CASE WHEN i.to_compartment_id IS NOT NULL THEN i.quantity_kg ELSE 0 END                      - CASE WHEN i.from_compartment_id IS NOT NULL THEN i.quantity_kg ELSE 0 END            ) AS qty_delta        FROM inserted i        LEFT JOIN SILO_COMPARTMENT sc            ON sc.compartment_id = COALESCE(i.to_compartment_id, i.from_compartment_id)        GROUP BY sc.silo_id        UNION ALL--silinen        SELECT            sc.silo_id,            SUM(              - CASE WHEN d.to_compartment_id IS NOT NULL THEN d.quantity_kg ELSE 0 END              + CASE WHEN d.from_compartment_id IS NOT NULL THEN d.quantity_kg ELSE 0 END            ) AS qty_delta        FROM deleted d        LEFT JOIN SILO_COMPARTMENT sc            ON sc.compartment_id = COALESCE(d.to_compartment_id, d.from_compartment_id)        GROUP BY sc.silo_id    ),    silo_net AS (--ekleme, çýkarma hesabý        SELECT silo_id, SUM(qty_delta) AS qty_delta        FROM delta        WHERE silo_id IS NOT NULL        GROUP BY silo_id    )    UPDATE s               --silo_total_occupancy yi güncelle    SET s.silo_total_occupancy = ISNULL(s.silo_total_occupancy, 0) + sn.qty_delta    FROM SILO s    JOIN silo_net sn ON sn.silo_id = s.silo_id;END--------CREATE OR ALTER TRIGGER TRG_SILO_UpdateBranchCapacity  --silo eklenince,silinince,güncellenince branch_total_capacity güncelleniyorON SILOAFTER INSERT, UPDATE, DELETEASBEGIN    SET NOCOUNT ON;    ;WITH affected AS (  --etkilenenler        SELECT branch_id FROM inserted        UNION        SELECT branch_id FROM deleted    )    UPDATE b    SET b.branch_total_capacity = x.total_capacity    FROM BRANCH b    JOIN (        SELECT s.branch_id, CAST(SUM(s.capacity_kg) AS DECIMAL(12,3)) AS total_capacity        FROM SILO s        GROUP BY s.branch_id    ) x ON x.branch_id = b.branch_id    WHERE b.branch_id IN (SELECT branch_id FROM affected);END----------CREATE OR ALTER TRIGGER TRG_MOVEMENT_NegativeSiloOccupancy --Yapýlmaya çalýþýlan movement dan sonra silo doluluðu eksiye düþemezON MOVEMENTAFTER INSERT, UPDATE, DELETEASBEGIN    SET NOCOUNT ON;    DECLARE @AffectedSilo TABLE (silo_id INT PRIMARY KEY);    --eklenenlerden etkilenenler    INSERT INTO @AffectedSilo(silo_id)    SELECT DISTINCT sc.silo_id    FROM inserted i    JOIN SILO_COMPARTMENT sc      ON sc.compartment_id = COALESCE(i.to_compartment_id, i.from_compartment_id)    WHERE sc.silo_id IS NOT NULL;    --silinenlerden etkilenenler    INSERT INTO @AffectedSilo(silo_id)    SELECT DISTINCT sc.silo_id    FROM deleted d    JOIN SILO_COMPARTMENT sc      ON sc.compartment_id = COALESCE(d.to_compartment_id, d.from_compartment_id)    WHERE sc.silo_id IS NOT NULL      AND sc.silo_id NOT IN (SELECT silo_id FROM @AffectedSilo);    --negatif kontrol    IF EXISTS (        SELECT 1        FROM SILO s        JOIN @AffectedSilo a ON a.silo_id = s.silo_id        WHERE ISNULL(s.silo_total_occupancy, 0) < 0    )    BEGIN        RAISERROR('Silo occupancy cannot be negative.', 16, 1);        ROLLBACK TRANSACTION;        RETURN;    ENDEND-------------------CREATE OR ALTER TRIGGER TRG_MOVEMENT_OverCapacity --toplam kapasite aþýlmasýnON MOVEMENTAFTER INSERT, UPDATE, DELETEASBEGIN    SET NOCOUNT ON;    DECLARE @AffectedSilo TABLE (silo_id INT PRIMARY KEY);    INSERT INTO @AffectedSilo(silo_id)    SELECT DISTINCT sc.silo_id    FROM inserted i    JOIN SILO_COMPARTMENT sc      ON sc.compartment_id = COALESCE(i.to_compartment_id, i.from_compartment_id)    WHERE sc.silo_id IS NOT NULL;    INSERT INTO @AffectedSilo(silo_id)    SELECT DISTINCT sc.silo_id    FROM deleted d    JOIN SILO_COMPARTMENT sc      ON sc.compartment_id = COALESCE(d.to_compartment_id, d.from_compartment_id)    WHERE sc.silo_id IS NOT NULL      AND sc.silo_id NOT IN (SELECT silo_id FROM @AffectedSilo);    IF EXISTS (        SELECT 1        FROM SILO s        JOIN @AffectedSilo a ON a.silo_id = s.silo_id        WHERE ISNULL(s.silo_total_occupancy, 0) > s.capacity_kg    )    BEGIN        RAISERROR('Silo occupancy cannot exceed silo capacity.', 16, 1);        ROLLBACK TRANSACTION;        RETURN;    ENDEND---------CREATE OR ALTER TRIGGER TRG_MOVEMENT_LotOutNotExceedInitialKg --from_compartment_id initial_kg yi aþmasýnON MOVEMENTAFTER INSERT, UPDATE, DELETEASBEGIN    SET NOCOUNT ON;    DECLARE @AffectedLot TABLE (lot_id INT PRIMARY KEY);    INSERT INTO @AffectedLot(lot_id)    SELECT DISTINCT lot_id FROM inserted    WHERE lot_id IS NOT NULL;    INSERT INTO @AffectedLot(lot_id)    SELECT DISTINCT lot_id FROM deleted    WHERE lot_id IS NOT NULL      AND lot_id NOT IN (SELECT lot_id FROM @AffectedLot);    IF EXISTS (        SELECT 1        FROM LOT l        JOIN @AffectedLot a ON a.lot_id = l.lot_id        WHERE ISNULL((            SELECT SUM(m.quantity_kg)            FROM MOVEMENT m            WHERE m.lot_id = l.lot_id              AND m.from_compartment_id IS NOT NULL   -- çýkýþ        ), 0) > l.initial_kg    )    BEGIN        RAISERROR('Lot outbound movement cannot exceed LOT.initial_kg.', 16, 1);        ROLLBACK TRANSACTION;        RETURN;    ENDEND-----------CREATE OR ALTER TRIGGER TRG_SALESORDER_AutoDeliverClose --saleorder daki status close olunca çalýþýr, yani teslim olunca çalýþýrON SALESORDER                                           -- allocation bu trigger ile oluþturuluyor, teslim edilenlerAFTER UPDATEASBEGIN    SET NOCOUNT ON;    --yeni kapanan sipariþ var mý?    IF NOT EXISTS (        SELECT 1        FROM inserted i                         --eskisi closed deðilken, yeni closed olduysa        JOIN deleted d ON d.so_id = i.so_id        WHERE i.status = 'CLOSED'          AND ISNULL(d.status,'') <> 'CLOSED'    )        RETURN;    IF OBJECT_ID('tempdb..#Pick') IS NOT NULL DROP TABLE #Pick;    ;WITH NewlyClosed AS (        SELECT i.so_id, i.branch_id, i.order_date        FROM inserted i                              --kapanan sipariþleri seç        JOIN deleted d ON d.so_id = i.so_id        WHERE i.status = 'CLOSED'          AND ISNULL(d.status,'') <> 'CLOSED'    ),    ClosedLines AS (        SELECT            sol.sol_id,            sol.so_id,            nc.branch_id,            nc.order_date,               --seçilen satýrlar            sol.product_id,            CAST(sol.quantity_kg AS DECIMAL(12,3)) AS order_qty        FROM SALESORDERLINE sol        JOIN NewlyClosed nc ON nc.so_id = sol.so_id    ),    LotCompStock AS (       --hangi lot nerede ne kadar var        SELECT            s.branch_id,            l.product_id,            m.lot_id,            comp.compartment_id,            CAST(SUM(                CASE WHEN m.to_compartment_id   = comp.compartment_id THEN m.quantity_kg ELSE 0 END  --giriþ              - CASE WHEN m.from_compartment_id = comp.compartment_id THEN m.quantity_kg ELSE 0 END  --çýkýþ            ) AS DECIMAL(12,3)) AS available_qty        FROM (            SELECT DISTINCT lot_id, COALESCE(to_compartment_id, from_compartment_id) AS compartment_id            FROM MOVEMENT            WHERE COALESCE(to_compartment_id, from_compartment_id) IS NOT NULL        ) comp        JOIN MOVEMENT m ON m.lot_id = comp.lot_id        JOIN LOT l ON l.lot_id = comp.lot_id                  JOIN SILO_COMPARTMENT sc ON sc.compartment_id = comp.compartment_id        JOIN SILO s ON s.silo_id = sc.silo_id        GROUP BY s.branch_id, l.product_id, m.lot_id, comp.compartment_id     --lot hangi ürüne ait        HAVING SUM(            CASE WHEN m.to_compartment_id   = comp.compartment_id THEN m.quantity_kg ELSE 0 END          - CASE WHEN m.from_compartment_id = comp.compartment_id THEN m.quantity_kg ELSE 0 END        ) > 0    )    SELECT   --uygun tek lot ve bölme bulma        cl.sol_id,        cl.order_date,        cl.order_qty,        x.lot_id,        x.compartment_id    INTO #Pick    FROM ClosedLines cl    CROSS APPLY (        SELECT TOP 1            lcs.lot_id,            lcs.compartment_id,            lcs.available_qty        FROM LotCompStock lcs        WHERE lcs.branch_id  = cl.branch_id          AND lcs.product_id = cl.product_id          AND lcs.available_qty >= cl.order_qty        ORDER BY lcs.available_qty DESC, lcs.lot_id    ) x;--yeni oluþan closed için stok yetiyor mu?    IF EXISTS (        SELECT 1        FROM SALESORDERLINE sol        JOIN SALESORDER so ON so.so_id = sol.so_id        JOIN inserted i ON i.so_id = so.so_id        JOIN deleted d ON d.so_id = so.so_id        WHERE i.status = 'CLOSED'          AND ISNULL(d.status,'') <> 'CLOSED'          AND NOT EXISTS (SELECT 1 FROM #Pick p WHERE p.sol_id = sol.sol_id)    )    BEGIN        RAISERROR('Auto-delivery failed: Some CLOSED lines do not have enough stock in a single lot+compartment in the same branch.', 16, 1);        ROLLBACK TRANSACTION;        RETURN;    END    IF EXISTS (    --ayný sol_id için tekrar yapmaz, çift teslimat olmaz        SELECT 1        FROM #Pick p        WHERE EXISTS (SELECT 1 FROM ALLOCATION a WHERE a.sol_id = p.sol_id)    )    BEGIN        RAISERROR('Auto-delivery blocked: Allocation already exists for at least one SalesOrderLine.', 16, 1);        ROLLBACK TRANSACTION;        RETURN;    END--Allocation a yazar    INSERT INTO ALLOCATION (sol_id, lot_id, allocated_kg)    SELECT p.sol_id, p.lot_id, p.order_qty    FROM #Pick p;--Movement a yazar    INSERT INTO MOVEMENT (lot_id, from_compartment_id, to_compartment_id, quantity_kg, movement_datetime)    SELECT p.lot_id, p.compartment_id, NULL, p.order_qty, DATEADD(MINUTE, 1, p.order_date)    FROM #Pick p;ENDSELECT   OBJECT_NAME(parent_id) AS table_name,  name AS trigger_nameFROM sys.triggersORDER BY table_name, trigger_name;UPDATE SALESORDERSET status = 'CLOSED'WHERE so_id = 12;   -- OPEN olan bir sipariþ seçUPDATE SALESORDERSET status = 'CLOSED'WHERE so_id = 16;   SELECT * FROM SALESORDERSELECT * FROM ALLOCATIONORDER BY allocation_id;SELECT * FROM MOVEMENTWHERE to_compartment_id IS NULLORDER BY movement_id;